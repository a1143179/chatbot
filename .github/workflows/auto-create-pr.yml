name: Auto Create Pull Request

on:
  push:
    branches:
      - working
      - feature/*
      - hotfix/*
      - bugfix/*
      - develop
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'

jobs:
  auto-create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      statuses: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTION_PAT }}

      - name: Check if PR exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.ACTION_PAT }}
        run: |
          # Get the current branch name
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Check if a PR already exists for this branch with retry mechanism
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to check PR existence (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            
            PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq 'length')
            
            if [ ! -z "$PR_EXISTS" ] && [ "$PR_EXISTS" != "null" ]; then
              echo "Successfully checked PR existence: $PR_EXISTS"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Failed to check PR existence, retrying in 10 seconds..."
                sleep 10
              else
                echo "Failed to check PR existence after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          if [ "$PR_EXISTS" -eq 0 ]; then
            echo "No PR exists for branch $BRANCH_NAME"
          else
            echo "PR already exists for branch $BRANCH_NAME"
          fi

      - name: Get commit messages
        id: commits
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          # Get the last 5 commit messages for PR description
          COMMIT_MESSAGES=$(git log --oneline -5 --no-merges)
          echo "commit_messages<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0'
        env:
          GH_TOKEN: ${{ secrets.ACTION_PAT }}
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          
          # Determine target branch based on current branch
          if [[ "$BRANCH_NAME" == "working" ]]; then
            TARGET_BRANCH="main"
            PR_TITLE="üöÄ Deploy to Production"
            PR_BODY="## üöÄ Production Deployment
          
          This PR contains changes ready for production deployment.
          
          ### üìã What's Changed
          - Automated deployment from working branch
          - All tests passing ‚úÖ
          - Ready for review and merge
          
          ### üîÑ Recent Commits
          \`\`\`
          ${{ steps.commits.outputs.commit_messages }}
          \`\`\`
          
          ### ‚úÖ Checklist
          - [ ] Tests passing
          - [ ] Code reviewed
          - [ ] Ready for deployment
          - [ ] No breaking changes"
          
          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            TARGET_BRANCH="working"
            PR_TITLE="üîÑ Merge Develop to Working"
            PR_BODY="## üîÑ Development Updates
          
          This PR merges development changes to the working branch.
          
          ### üìã What's Changed
          - Development updates from develop branch
          - Ready for testing and review
          
          ### üîÑ Recent Commits
          \`\`\`
          ${{ steps.commits.outputs.commit_messages }}
          \`\`\`
          
          ### ‚úÖ Checklist
          - [ ] Tests passing
          - [ ] Code reviewed
          - [ ] Ready for working branch"
          
          elif [[ "$BRANCH_NAME" =~ ^feature/ ]]; then
            TARGET_BRANCH="develop"
            FEATURE_NAME=$(echo "$BRANCH_NAME" | sed 's/feature\///')
            PR_TITLE="‚ú® Feature: $FEATURE_NAME"
            PR_BODY="## ‚ú® Feature: $FEATURE_NAME
          
          This PR adds the $FEATURE_NAME feature.
          
          ### üìã What's Changed
          - New feature implementation
          - Ready for review and testing
          
          ### üîÑ Recent Commits
          \`\`\`
          ${{ steps.commits.outputs.commit_messages }}
          \`\`\`
          
          ### ‚úÖ Checklist
          - [ ] Tests passing
          - [ ] Code reviewed
          - [ ] Feature tested
          - [ ] Documentation updated"
          
          elif [[ "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            TARGET_BRANCH="working"
            HOTFIX_NAME=$(echo "$BRANCH_NAME" | sed 's/hotfix\///')
            PR_TITLE="üö® Hotfix: $HOTFIX_NAME"
            PR_BODY="## üö® Hotfix: $HOTFIX_NAME
          
          This PR contains a critical hotfix.
          
          ### üìã What's Changed
          - Critical bug fix
          - Urgent deployment needed
          
          ### üîÑ Recent Commits
          \`\`\`
          ${{ steps.commits.outputs.commit_messages }}
          \`\`\`
          
          ### ‚úÖ Checklist
          - [ ] Tests passing
          - [ ] Code reviewed
          - [ ] Critical fix verified
          - [ ] Ready for immediate deployment"
          
          elif [[ "$BRANCH_NAME" =~ ^bugfix/ ]]; then
            TARGET_BRANCH="develop"
            BUGFIX_NAME=$(echo "$BRANCH_NAME" | sed 's/bugfix\///')
            PR_TITLE="üêõ Bugfix: $BUGFIX_NAME"
            PR_BODY="## üêõ Bugfix: $BUGFIX_NAME
          
          This PR fixes a bug in the codebase.
          
          ### üìã What's Changed
          - Bug fix implementation
          - Ready for review and testing
          
          ### üîÑ Recent Commits
          \`\`\`
          ${{ steps.commits.outputs.commit_messages }}
          \`\`\`
          
          ### ‚úÖ Checklist
          - [ ] Tests passing
          - [ ] Code reviewed
          - [ ] Bug fix verified
          - [ ] No regression introduced"
          
          else
            TARGET_BRANCH="develop"
            PR_TITLE="üìù Update from $BRANCH_NAME"
            PR_BODY="## üìù Update from $BRANCH_NAME
          
          This PR contains changes from the $BRANCH_NAME branch.
          
          ### üìã What's Changed
          - Updates from $BRANCH_NAME branch
          - Ready for review
          
          ### üîÑ Recent Commits
          \`\`\`
          ${{ steps.commits.outputs.commit_messages }}
          \`\`\`
          
          ### ‚úÖ Checklist
          - [ ] Tests passing
          - [ ] Code reviewed
          - [ ] Ready for merge"
          fi
          
          # Create the pull request with retry mechanism
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to create PR (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            
            if gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base "$TARGET_BRANCH" \
              --head "$BRANCH_NAME" \
              --draft; then
              echo "Successfully created draft PR from $BRANCH_NAME to $TARGET_BRANCH"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Failed to create PR, retrying in 10 seconds..."
                sleep 10
              else
                echo "Failed to create PR after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Update existing PR
        if: steps.check-pr.outputs.pr_exists != '0'
        env:
          GH_TOKEN: ${{ secrets.ACTION_PAT }}
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          
          # Get the PR number with retry mechanism
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to get PR number (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            
            PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
            
            if [ ! -z "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
              echo "Successfully got PR number: $PR_NUMBER"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Failed to get PR number, retrying in 10 seconds..."
                sleep 10
              else
                echo "Failed to get PR number after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          # Get recent commits for update
          COMMIT_MESSAGES=$(git log --oneline -3 --no-merges)
          
          # Update the PR with latest changes and retry mechanism
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to update PR (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            
            if gh pr edit $PR_NUMBER --body "Updated with latest changes from $BRANCH_NAME
          
          ### üîÑ Recent Updates
          \`\`\`
          $COMMIT_MESSAGES
          \`\`\`"; then
              echo "Successfully updated existing PR #$PR_NUMBER for branch $BRANCH_NAME"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Failed to update PR, retrying in 10 seconds..."
                sleep 10
              else
                echo "Failed to update PR after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done 